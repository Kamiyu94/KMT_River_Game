<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç«‹å§”éæ²³ V13.3 æœ€çµ‚æµæš¢ç‰ˆ</title>
    <style>
        /* --- å…¨å±€è®Šæ•¸ --- */
        :root {
            --bg-sea: #81d4fa;
            --bg-china: #eeeeee;
            --bg-taiwan: #e8f5e9;
            --boat-color: #795548;
            --accent-red: #d32f2f;
            --card-male: #e3f2fd;
            --card-female: #fce4ec;
            --dashboard-height: 260px;
        }

        body {
            margin: 0;
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            background-color: var(--bg-sea);
            height: 100vh;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            transition: background-color 2s ease;
        }
        
        body.victory-mode { background-color: #66bb6a !important; }
        
        /* è¦†è“‹å±¤èˆ‡å½ˆçª—é€šç”¨ */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }

        /* å‹åˆ©ç‰¹æ•ˆ (ä¿®æ­£ï¼šå¯é»æ“Š) */
        #victory-overlay {
            background: rgba(0,0,0,0.3); /* ç¨å¾®é€ä¸€é»ç¶  */
            cursor: pointer; /* è®“é¼ æ¨™è®Šæ‰‹æ‰‹ */
            pointer-events: auto; /* å…è¨±æ¥æ”¶é»æ“Š */
        }
        #victory-text {
            font-size: 40px; font-weight: bold; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            text-align: center; animation: popIn 1s forwards;
        }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* è¦å‰‡èªªæ˜è¦–çª— */
        #rules-box {
            background: #fff; width: 90%; max-width: 600px; max-height: 80vh;
            border-radius: 10px; padding: 20px; overflow-y: auto;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
            position: relative; font-size: 15px; line-height: 1.6;
        }
        #rules-box h2 { margin-top: 0; color: #d32f2f; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        #rules-box h3 { margin: 15px 0 5px; color: #333; background: #eee; padding: 5px; border-radius: 4px; }
        #rules-box ul { padding-left: 20px; margin: 5px 0; }
        #rules-box li { margin-bottom: 5px; }
        .close-btn {
            position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #999;
        }
        .btn-rules {
            position: absolute; top: 10px; left: 10px; z-index: 200;
            background: #fff; border: 2px solid #555;
            color: #333 !important;
            padding: 8px 15px; border-radius: 25px; font-size: 14px; cursor: pointer;
            font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .btn-rules:active { transform: scale(0.95); }

        /* éª°å­è¦–çª— */
        #dice-box {
            background: #fff; padding: 20px; border-radius: 20px; text-align: center;
            box-shadow: 0 0 20px rgba(255,255,255,0.5); width: 300px;
        }
        #dice-display { font-size: 80px; margin: 20px 0; }
        #dice-msg { font-size: 18px; margin-bottom: 20px; color: #555; }
        #btn-roll {
            background: #ff9800; color: white; border: none; padding: 10px 30px;
            font-size: 24px; border-radius: 50px; cursor: pointer; box-shadow: 0 4px 0 #e65100;
        }
        #btn-roll:active { transform: translateY(4px); box-shadow: none; }

        /* éŠæˆ²å€åŸŸ */
        #game-stage { flex: 1; position: relative; display: flex; overflow: hidden; padding-bottom: var(--dashboard-height); }

        @media (max-width: 768px) {
            #game-stage { flex-direction: column; }
            .bank { width: 100%; border-bottom: 4px solid #ccc; border-top: 4px solid #81c784; }
            #area-river { width: 100%; height: 180px; flex-shrink: 0; }
            #boat {
                flex-direction: row; width: 220px; height: 80px;
                transition: top 1s ease-in-out;
                left: 50%; transform: translateX(-50%);
            }
            #boat.at-taiwan { top: calc(100% - 90px); }
            #boat.at-china { top: 10px; }
            .geo-label { width: 100%; text-align: center; padding: 5px 0; font-size: 16px; }
        }

        @media (min-width: 769px) {
            #game-stage { flex-direction: row; padding-bottom: var(--dashboard-height); }
            .bank { height: 100%; width: 30%; border-right: 4px solid #ccc; border-left: 4px solid #81c784; }
            #area-river { flex: 1; height: 100%; }
            #boat {
                flex-direction: row; width: 220px; height: 80px;
                transition: left 1s ease-in-out;
                top: 50%; transform: translateY(-50%);
            }
            #boat.at-taiwan { left: calc(100% - 240px); }
            #boat.at-china { left: 20px; }
            .geo-label { width: 100%; text-align: center; padding: 15px 0; font-size: 24px !important; }
        }

        .bank {
            position: relative; display: flex; flex-direction: column; align-items: center;
            padding: 10px; overflow-y: auto; flex: 1;
        }
        #area-china { background-color: var(--bg-china); order: 1; }
        #area-river { position: relative; order: 2; z-index: 10; }
        #area-taiwan { background-color: var(--bg-taiwan); order: 3; }

        .geo-label {
            font-size: 18px; font-weight: bold; color: #555; margin-bottom: 10px;
            background: rgba(255,255,255,0.6); padding: 4px 10px; border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .char-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; width: 100%; padding-bottom: 20px; }

        #boat {
            position: absolute; background-color: var(--boat-color);
            border-radius: 50px; border: 4px solid #4e342e;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4); z-index: 50;
        }
        #boat::after {
            content: "2äººåº§"; position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
            font-size: 12px; color: #333; font-weight: bold;
            background: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 4px;
        }

        .card {
            width: 80px; height: 100px; background: #fff; border: 2px solid #333; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
            padding: 4px; cursor: pointer; box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            position: relative; transition: transform 0.1s;
        }
        .card:active { transform: scale(0.95); }
        .card.male { background-color: var(--card-male); border-top: 4px solid #2196f3; }
        .card.female { background-color: var(--card-female); border-top: 4px solid #e91e63; }
        .card[data-id="orange"] { border: 3px solid #ff9800; background: #fff3e0; }
        .card.jailed { background: #b0bec5; opacity: 0.7; cursor: not-allowed; border-color: #546e7a; }
        .card.jailed.rescuable { cursor: alias; border-color: #ff9800; box-shadow: 0 0 8px #ff9800; opacity: 1; }

        .card-icon { font-size: 30px; line-height: 1.2; }
        .card-name { font-size: 13px; font-weight: bold; text-align: center; line-height: 1.1; color: #333; }
        .card-money { font-size: 11px; color: #1b5e20; font-weight: bold; background: rgba(255,255,255,0.5); padding: 2px; border-radius: 4px; width: 100%; text-align: center; }
        .badge-driver { position: absolute; top: 2px; right: 2px; font-size: 14px; }
        .badge-ban { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; color: #d32f2f; opacity: 0.9; }

        #dashboard { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--dashboard-height); 
            background: #fff; border-top: 4px solid #333; display: flex; flex-direction: column; 
            padding: 10px; box-sizing: border-box; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        #log-container { flex: 1; background: #fafafa; border: 2px solid #ccc; border-radius: 8px; padding: 8px; overflow-y: auto; margin-bottom: 8px; }
        #log-list { margin: 0; padding: 0; list-style: none; }
        .log-item { font-size: 16px; line-height: 1.5; border-bottom: 1px dashed #ddd; padding: 5px 0; color: #333; }
        .log-time { color: #999; font-size: 12px; margin-right: 6px; font-family: monospace; }
        .log-highlight { color: #d32f2f; font-weight: bold; background: #ffebee; }
        #controls { display: flex; gap: 10px; height: 55px; }
        button { border: none; border-radius: 10px; font-size: 20px; font-weight: bold; color: white; cursor: pointer; box-shadow: 0 3px 0 rgba(0,0,0,0.3); }
        button:active { transform: translateY(2px); box-shadow: 0 1px 0 rgba(0,0,0,0.3); }
        #btn-move { flex: 3; background: var(--accent-red); }
        #btn-reset { flex: 1; background: #607d8b; }
    </style>
</head>
<body>
    <button class="btn-rules" onclick="toggleRules()">ğŸ“– éŠæˆ²èªªæ˜æ›¸</button>

    <div id="rules-overlay" class="overlay">
        <div id="rules-box">
            <span class="close-btn" onclick="toggleRules()">&times;</span>
            <h2>ğŸ“‘ ç«‹å§”æ¸¡æ²³ä½œæˆ°è¨ˆç•«</h2>
            <h3>ğŸ¯ ä»»å‹™ç›®æ¨™</h3>
            <p>å°‡ç«‹å§”é‹é€è‡³ä¸­åœ‹ã€‚æˆåŠŸæŠµé” 5 äººä»¥ä¸Šå³ç‚ºã€ŒæŠ•èª æˆåŠŸã€ï¼›è‹¥å…¨è»è¦†æ²’ï¼Œå‰‡ç‚ºã€Œå°ç£äººæ°‘å‹åˆ©ã€ã€‚</p>
            
            <h3>âš ï¸ é‡è¦æç¤º (åœ‹æ°‘é»¨)</h3>
            <ul>
                <li><b>å‚…å´‘è</b>ï¼šèº«åƒ¹ 500 è¬ï¼Œä½†é§•é§›æŠ€è¡“å ªæ†‚ï¼Œè‹¥æ²’äººå¹«ä»–é–‹èˆ¹æœƒæ²ˆèˆ¹ã€‚</li>
                <li><b>ç¾…æ™ºå¼·</b>ï¼šæœƒå‘åŒèˆ¹è€…å¼·è¿«æ¨éŠ· 100 è¬çš„æ›¸ï¼Œæ²’éŒ¢ä»˜å°±æœƒè¢«æ¨ä¸‹æµ·ã€‚</li>
                <li><b>å¾å·§èŠ¯</b>ï¼šå˜´ç ²è¼¸å‡ºã€‚è‹¥<b>é„­éº—æ–‡</b>ä¸åœ¨èˆ¹ä¸Šå£“åˆ¶å¥¹ï¼Œå¥¹æœƒç½µåˆ°èˆ¹é–‹ä¸å‹•ã€‚</li>
                <li><b>ç‹é´»è–‡</b>ï¼šæƒ…ç·’ä¸ç©©ï¼Œæ•´å ´éŠæˆ²æœƒéš¨æ©Ÿå°ä¸€ååŒé»¨ç”·æ€§å‡ºæ‰‹ã€‚</li>
                <li><b>é„­éº—æ–‡</b>ï¼šå¿…é ˆåœ¨å‰ 5 ä½æŠµé”ï¼Œå¦å‰‡æœƒé²åˆ°æš´æ€’ç¿»èˆ¹ã€‚</li>
                <li><b>é¦¬/éŸ“</b>ï¼šè‹¥æœ±ç«‹å€«ä¸åœ¨ï¼Œä»–å€‘æœƒå°å‚…å´‘èä¸åˆ©ã€‚</li>
                <li><b>é™³ç‰ç</b>ï¼šé‡é‡ç´šäººç‰©ï¼Œä¸€äººä½” 2 å€‹èˆ¹ä½ã€‚</li>
            </ul>

            <h3>âš ï¸ æ°‘çœ¾é»¨ (å¯é¸æ¨¡å¼)</h3>
            <ul>
                <li><b>æŸ¯æ–‡å“²</b>ï¼šè©±å¾ˆå¤šï¼Œé–‹èˆ¹æœƒæ‹–å»¶ã€‚è‹¥åœ¨å°ç£è¢«ç¾ˆæŠ¼ï¼Œè«‹ç­‰å¾…æ•‘æ´ã€‚</li>
                <li><b>é»ƒåœ‹æ˜Œ</b>ï¼š<b>ã€é—œéµã€‘</b>è‹¥ä»–å¤ªæ™šå»ä¸­åœ‹ï¼Œæœƒç”¨ç‹—ä»”æ¯€æ»…å‰ 5 æ‰¹æŠµé”çš„äººã€‚</li>
                <li><b>é™³ç®çª</b>ï¼šæŸ¯æ–‡å“²çš„é‡‘åº«ã€‚è‹¥å¤«å¦»åŒåœ¨ä¸­åœ‹å¯è§¸ç™¼ã€Œè±ªå®…ç„¡æ•µã€æ¨¡å¼ã€‚</li>
                <li><b>é¤¨é•·</b>ï¼šå–œæ­¡åœ¨å°å²¸å¤§æ”¾å¥è©ï¼Œä½†è«‹å°å¿ƒä¸­åœ‹äººæ°‘çš„è€å¿ƒã€‚</li>
                <li><b>å³æ€¡è±</b>ï¼šé›–ç„¶åªæ˜¯ç™¼è¨€äººï¼Œä½†è‹¥è½å–®é‡åˆ°åœ‹æ°‘é»¨å¥³å°‡ï¼Œå¯èƒ½æœƒé­é‡ä¸æ¸¬ã€‚</li>
            </ul>

            <h3>ğŸ”’ éš±è—è¦ç´ </h3>
            <p>é™¤äº†ç¾åœ¨çœ‹åˆ°çš„ 16 äººï¼Œé‚„æœ‰ä¸€å€‹éš±è—äººç‰©ï¼Œåªåœ¨ç¬¦åˆæ¢ä»¶çš„æ™‚å€™å‡ºç¾ï¼Œä½ èƒ½æ‰¾å¾—åˆ°å¥¹å—ï¼Ÿ</p>
        </div>
    </div>

    <div id="victory-overlay" class="overlay" onclick="startNewGame()">
        <div style="font-size:80px;">ğŸ‰ğŸ‰ğŸ‰</div>
        <div id="victory-text">å°ç£äººæ°‘å¤§å‹åˆ©</div>
        <div style="font-size:20px; color:white; margin-top:10px;">å¤©ä½‘å°ç£ æ­²æœˆéœå¥½</div>
        <div style="font-size:14px; color:white; margin-top:30px; opacity:0.8;">(é»æ“Šç•«é¢é‡æ–°é–‹å§‹)</div>
    </div>

    <div id="dice-overlay" class="overlay">
        <div id="dice-box">
            <h2>ğŸŠ æ©˜å­æ•‘æ´è¡Œå‹•</h2>
            <div id="dice-msg">...</div>
            <div id="dice-display">ğŸ²</div>
            <button id="btn-roll" onclick="rollDiceAction()">æ“²éª°å­ï¼</button>
        </div>
    </div>

    <div id="game-stage">
        <div id="area-china" class="bank">
            <div class="geo-label">ğŸ‡¨ğŸ‡³ ä¸­åœ‹</div>
            <div id="list-china" class="char-container"></div>
        </div>
        <div id="area-river">
            <div id="boat" class="at-taiwan"></div>
        </div>
        <div id="area-taiwan" class="bank">
            <div class="geo-label">ğŸ‡¹ğŸ‡¼ å°ç£</div>
            <div id="list-taiwan" class="char-container"></div>
        </div>
    </div>

    <div id="dashboard">
        <div id="log-container">
            <ul id="log-list"></ul>
        </div>
        <div id="controls">
            <button id="btn-reset" onclick="startNewGame()">é‡ç½®</button>
            <button id="btn-move" onclick="moveBoat()">ğŸš¢ é–‹èˆ¹</button>
        </div>
    </div>

<script>
    const GOSSIP_DB = {
        'fuqunzhu': 'è‡ªç¨±ä»£è¡¨å°ç£ä¸­å¤®æ”¿åºœï¼Œæš—ç¤ºå°ç£ç¨ç«‹',
        'xuxiaoqin': 'é•åœé‚„å°äº¤è­¦æ¯”ä¸­æŒ‡ï¼Œä¸¦æ›¾å“­å€’åœ¨æœ‰å©¦ä¹‹å¤«æ‡·è£¡',
        'wanghongwei': 'æŒ‘é‡è·³èˆå¤ªé›£çœ‹ï¼Œåœ¨å€’å¡Œå¤§æ¨“å‰é–‹å¿ƒè‡ªæ‹',
        'zhulilun': 'é ­é«®è¶Šä¾†è¶Šå°‘ï¼ŒæŠ•èª å ±é…¬ç‡å¤ªä½',
        'luozhiqiang': 'è¦åƒ¹100è¬çš„æ›¸åªæœ‰å°é¢',
        'mayingjeou': 'å…­ä¸‰ä¸‰æ²’åšåˆ°ä¹Ÿæ²’ä¾ç´„æè–ªæ°´',
        'guanchang': 'æ€§é¨·æ“¾å“¡å·¥è€Œä¸”åªæœ‰ä¸‰å…¬åˆ†',
        'hanguoyu': 'åœ¨åŒ—è¾²æ™‚æœŸæ¯å¤©æ™šä¸Šå–é…’ã€ç©å¥³äºº'
    };

    const ALL_CHARS = [
        { id: 'hanguoyu', name: 'éŸ“åœ‹ç‘œ', gender: 'm', money: 100, canDrive: true, size: 1, emoji: 'ğŸŸ', type: 'kmt' },
        { id: 'fuqunzhu', name: 'å‚…å´‘è', gender: 'm', money: 500, canDrive: false, size: 1, emoji: 'ğŸ‘‘', type: 'kmt' },
        { id: 'zhulilun', name: 'æœ±ç«‹å€«', gender: 'm', money: 100, canDrive: true, size: 1, emoji: 'ğŸ¤“', type: 'kmt' },
        { id: 'xuxiaoqin', name: 'å¾å·§èŠ¯', gender: 'f', money: 100, canDrive: false, size: 1, emoji: 'ğŸ', type: 'kmt' },
        { id: 'zhengliwen', name: 'é„­éº—æ–‡', gender: 'f', money: 100, canDrive: true, size: 1, emoji: 'ğŸ‘ ', type: 'kmt' },
        { id: 'wanghongwei', name: 'ç‹é´»è–‡', gender: 'f', money: 100, canDrive: false, size: 1, emoji: 'ğŸ’£', type: 'kmt' },
        { id: 'luozhiqiang', name: 'ç¾…æ™ºå¼·', gender: 'm', money: 100, canDrive: true, size: 1, emoji: 'ğŸ“–', type: 'kmt' },
        { id: 'chenyuzhen', name: 'é™³ç‰ç', gender: 'f', money: 100, canDrive: true, size: 2, emoji: 'ğŸ›¡ï¸', type: 'kmt' },
        { id: 'yeyuanzhi', name: 'è‘‰å…ƒä¹‹', gender: 'm', money: 100, canDrive: false, size: 1, emoji: 'ğŸ˜¨', type: 'kmt' },
        { id: 'wengxiaoling', name: 'ç¿æ›‰ç²', gender: 'f', money: 100, canDrive: false, size: 1, emoji: 'âš–ï¸', type: 'kmt' },
        { id: 'mayingjeou', name: 'é¦¬è‹±ä¹', gender: 'm', money: 100, canDrive: true, size: 1, emoji: 'ğŸ´', type: 'kmt' },
        // TPP
        { id: 'kowenje', name: 'æŸ¯æ–‡å“²', gender: 'm', money: 1500, canDrive: false, size: 1, emoji: 'ğŸ¤“', type: 'tpp' },
        { id: 'huangkuochang', name: 'é»ƒåœ‹æ˜Œ', gender: 'm', money: 100, canDrive: false, size: 1, emoji: 'ğŸ¤¬', type: 'tpp' },
        { id: 'peggy', name: 'é™³ç®çª', gender: 'f', money: 100, canDrive: false, size: 1, emoji: 'ğŸ¦', type: 'tpp' },
        { id: 'guanchang', name: 'é¤¨é•·', gender: 'm', money: 100, canDrive: false, size: 1, emoji: 'ğŸ’ª', type: 'tpp' },
        { id: 'wuyihsuan', name: 'å³æ€¡è±', gender: 'f', money: 100, canDrive: false, size: 1, emoji: 'ğŸ¤', type: 'tpp' }
    ];

    const ORANGE_DATA = { id: 'orange', name: 'æ©˜å­', gender: 'f', money: 3.5, canDrive: true, size: 1, emoji: 'ğŸŠ', type: 'tpp' };
    const KMT_MALE_IDS = ALL_CHARS.filter(c => c.type === 'kmt' && c.gender === 'm').map(c => c.id);
    const MALE_IDS = ALL_CHARS.filter(c => c.gender === 'm').map(c => c.id);
    const WANG_PROTECTORS = ['luozhiqiang', 'fuqunzhu', 'hanguoyu', 'zhulilun'];

    let chars = [];
    let boatLoc = 'taiwan';
    let chinaArrivals = [];
    let tripCount = 0;
    let gossipCount = 0;
    let koCoughed = false; 
    let hasWuComplained = false;
    let hasWangKilled = false;
    let koSavings = 0.0;
    let peggySaidNoMore = false;
    let orangeRescuedOnce = false;
    let isGameOver = false;
    let includeTPP = false;
    let deathQueue = [];
    let hasCaseTriggered = false;

    function toggleRules() {
        const el = document.getElementById('rules-overlay');
        el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
    }

    function startNewGame() {
        // é‡ç½®æ™‚å…ˆç¢ºèª victory overlay é—œé–‰ï¼Œé¿å…é›™é‡é»æ“Š
        document.getElementById('victory-overlay').style.display = 'none';
        
        setTimeout(() => {
            if (confirm("æ˜¯å¦è®“æ°‘çœ¾é»¨åƒåŠ æœ¬æ¬¡æ’¤é›¢è¡Œå‹•ï¼Ÿ")) {
                includeTPP = true;
                chars = JSON.parse(JSON.stringify(ALL_CHARS));
            } else {
                includeTPP = false;
                chars = JSON.parse(JSON.stringify(ALL_CHARS.filter(c => c.type === 'kmt')));
            }
            initGame();
        }, 100);
    }

    function initGame() {
        chars.forEach(c => {
            c.location = 'taiwan';
            c.isAlive = true;
            c.isJailed = false;
            c.isBald = false;
        });
        if(!includeTPP) chars = chars.filter(c => c.type === 'kmt');

        boatLoc = 'taiwan';
        chinaArrivals = [];
        tripCount = 0;
        gossipCount = 0;
        koCoughed = false;
        hasWuComplained = false;
        hasWangKilled = false;
        koSavings = 0.0;
        peggySaidNoMore = false;
        orangeRescuedOnce = false;
        isGameOver = false;
        deathQueue = [];
        hasCaseTriggered = false;

        document.body.classList.remove('victory-mode');
        document.getElementById('victory-overlay').style.display = 'none';
        document.getElementById('dice-overlay').style.display = 'none';
        document.getElementById('rules-overlay').style.display = 'none';
        document.getElementById('log-list').innerHTML = '';
        const btn = document.getElementById('btn-move');
        btn.textContent = "ğŸš¢ é–‹èˆ¹";
        btn.style.background = "#d32f2f";
        btn.disabled = false;

        log("éŠæˆ²é–‹å§‹ï¼ç›®æ¨™ï¼šå¾å°ç£æ’¤é›¢è‡³ä¸­åœ‹ã€‚", true);
        updateBoatUI();
        render();
    }

    function render() {
        const elTaiwan = document.getElementById('list-taiwan');
        const elChina = document.getElementById('list-china');
        const elBoat = document.getElementById('boat');

        elTaiwan.innerHTML = ''; elChina.innerHTML = '';
        Array.from(elBoat.children).forEach(c => {
            if(c.classList.contains('card')) elBoat.removeChild(c);
        });

        if(includeTPP) checkOrangeSpawn();

        chars.forEach(c => {
            if (!c.isAlive) return;

            const card = document.createElement('div');
            let cardClass = `card ${c.gender === 'm' ? 'male' : 'female'}`;
            if (c.isJailed) cardClass += ' jailed';
            
            const orange = chars.find(x => x.id === 'orange');
            if (orange && orange.location === 'taiwan' && !orange.isJailed && c.id === 'kowenje' && c.isJailed) {
                cardClass += ' rescuable';
            }

            card.className = cardClass;
            card.dataset.id = c.id;
            if (c.id === 'orange') card.dataset.id = 'orange';

            card.onclick = (e) => { e.stopPropagation(); clickChar(c.id); };

            const driverBadge = (c.canDrive && !c.isJailed) ? '<span class="badge-driver">âš“</span>' : '';
            const banBadge = c.isJailed ? '<span class="badge-ban">ğŸš«</span>' : '';
            let emoji = c.emoji;
            if (c.id === 'kowenje' && c.isBald) emoji = 'ğŸ‘¨â€ğŸ¦²';

            let moneyText = `$${c.money}è¬`;
            if (c.id === 'kowenje') {
                const total = (c.money/10000) + koSavings; 
                moneyText = `$${Math.floor(total*10000)}?`;
            }
            if (c.id === 'orange') moneyText = `${c.money}å„„`;
            
            card.innerHTML = `
                ${driverBadge}
                ${banBadge}
                <div class="card-icon">${emoji}</div>
                <div class="card-name">${c.name}</div>
                <div class="card-money">${moneyText}</div>
            `;

            if (c.location === 'taiwan') elTaiwan.appendChild(card);
            else if (c.location === 'china') elChina.appendChild(card);
            else if (c.location === 'boat') elBoat.appendChild(card);
        });
    }

    function clickChar(id) {
        if (isGameOver) return;
        const c = chars.find(x => x.id === id);

        const ko = chars.find(x => x.id === 'kowenje');
        if (c.id === 'peggy' && c.location === 'taiwan' && ko && ko.isJailed) {
            setTimeout(() => alert("é™³ç®çªï¼šã€Œæˆ‘ä¸èƒ½èµ°ï¼æˆ‘è¦ç•™ä¸‹ä¾†è½‰å¸³æ•‘é˜¿åŒ—ï¼ã€"), 50);
            return;
        }

        if (c.isJailed) {
            const orange = chars.find(x => x.id === 'orange');
            if (c.id === 'kowenje' && orange && orange.location === 'taiwan' && !orange.isJailed) {
                openDiceModal();
            } else {
                setTimeout(() => alert("å—¡...å—¡...å—¡... (æ­¤äººç¾ˆæŠ¼ä¸­)"), 50);
            }
            return;
        }

        if (c.location === 'boat') {
            c.location = boatLoc;
            koCoughed = false;
        } else {
            if (c.location !== boatLoc) { setTimeout(() => alert("èˆ¹åœ¨å°é¢ï¼"), 50); return; }
            if (getBoatSize() + c.size > 2) { setTimeout(() => alert("èˆ¹æ»¿äº†ï¼"), 50); return; }
            c.location = 'boat';
            koCoughed = false;
        }
        render();
    }

    function openDiceModal() {
        const orange = chars.find(x => x.id === 'orange');
        const totalAssets = orange.money + koSavings;
        
        let msg = "èŠ±è²»2å„„ï¼Œéª°å‡º 5 æˆ– 6 æ•‘é˜¿åŒ—ï¼";
        if (totalAssets >= 2.0 && !orangeRescuedOnce) {
            msg = "è³‡ç”¢å……è¶³(>2å„„)ï¼æœ¬æ¬¡è‹¥å¤±æ•—ä¸æœƒè¢«é—œï¼Œå¯äºŒåˆ·ï¼(è²»ç”¨2å„„)";
        } else if (orangeRescuedOnce) {
            msg = "ç¬¬äºŒæ¬¡æ©Ÿæœƒï¼åªæœ‰éª°å‡º 6 æ‰èƒ½æˆåŠŸï¼(è²»ç”¨2å„„)";
        }

        if (orange.money < 2) {
            const needed = 2 - orange.money;
            const neededFixed = Math.ceil(needed * 10) / 10;
            if (koSavings >= neededFixed) {
                if (confirm(`æ©˜å­èº«ä¸Šåªæœ‰ ${orange.money}å„„ã€‚æ˜¯å¦å¾æŸ¯æ–‡å“²å¸³æˆ¶è½‰ ${neededFixed}å„„ çµ¦æ©˜å­ï¼Ÿ`)) {
                    koSavings -= neededFixed;
                    orange.money += neededFixed;
                } else {
                    return;
                }
            } else {
                setTimeout(() => alert("æ©˜å­ç¾é‡‘ä¸è¶³2å„„ï¼ŒæŸ¯æ–‡å“²å­˜æ¬¾ä¹Ÿä¸å¤ ï¼"), 50); 
                return; 
            }
        }
        
        document.getElementById('dice-overlay').style.display = 'flex';
        document.getElementById('dice-msg').textContent = msg;
        document.getElementById('dice-display').textContent = 'ğŸ²';
        document.getElementById('btn-roll').disabled = false;
    }

    function rollDiceAction() {
        const diceDisplay = document.getElementById('dice-display');
        const btn = document.getElementById('btn-roll');
        btn.disabled = true;

        let counter = 0;
        const interval = setInterval(() => {
            const rand = Math.floor(Math.random() * 6) + 1;
            diceDisplay.textContent = getDiceEmoji(rand);
            counter++;
            if (counter > 10) {
                clearInterval(interval);
                finalizeRescue(rand);
            }
        }, 100);
    }

    function getDiceEmoji(num) { return ['âš€','âš','âš‚','âšƒ','âš„','âš…'][num-1]; }

    function finalizeRescue(roll) {
        const orange = chars.find(x => x.id === 'orange');
        const ko = chars.find(x => x.id === 'kowenje');
        const totalAssets = orange.money + koSavings;
        
        orange.money -= 2;
        orange.money = Math.round(orange.money * 10) / 10;

        setTimeout(() => {
            document.getElementById('dice-overlay').style.display = 'none';
            let success = false;
            if (orangeRescuedOnce) { if (roll === 6) success = true; } 
            else { if (roll >= 5) success = true; }

            if (success) {
                log(`[æ©˜å­] æ“²å‡º ${roll}ï¼Œç–é€šæˆåŠŸï¼æŸ¯æ–‡å“²è¢«ä¿é‡‹äº†ï¼`, true);
                ko.isJailed = false; ko.isBald = true;
                orangeRescuedOnce = false;
            } else {
                if (totalAssets >= 2.0 && !orangeRescuedOnce) {
                    log(`[æ©˜å­] æ“²å‡º ${roll} æ•‘æ´å¤±æ•—ï¼ä½†å› è³‡ç”¢é›„åšï¼ŒæˆåŠŸè¦é¿ç¾ˆæŠ¼ï¼`, true);
                    setTimeout(() => alert("æ•‘æ´å¤±æ•—ï¼ä½†é€ƒéä¸€åŠ«ï¼Œæ©˜å­å¯ä»¥å†æ¬¡å˜—è©¦ï¼"), 100);
                    orangeRescuedOnce = true;
                } else {
                    log(`[æ©˜å­] æ“²å‡º ${roll}ï¼Œæ•‘æ´å¤±æ•—ï¼`, true);
                    orange.money = 0; orange.isJailed = true;
                    setTimeout(() => alert("æ•‘æ´å¤±æ•—ï¼Œæ©˜å­è¢«ç¾ˆæŠ¼ç¦è¦‹ï¼"), 100);
                }
            }
            render();
            checkWin();
        }, 500);
    }

    function moveBoat() {
        if (isGameOver) return;
        const onBoat = chars.filter(c => c.location === 'boat');
        if (onBoat.length === 0) { setTimeout(() => alert("ç©ºèˆ¹ï¼"), 50); return; }

        const ko = onBoat.find(c => c.id === 'kowenje');
        if (ko && !koCoughed) {
            setTimeout(() => alert("æŸ¯æ–‡å“²ï¼šã€Œå’³å’³ï¼æˆ‘æ˜¯è¦ºå¾—æ€ªæ€ªçš„å•¦...ï¼ˆä¸‹ç•¥ä¸‰åƒå­—ï¼‰ã€\nå› ç‚ºå»¢è©±å¤ªå¤šï¼Œèˆ¹æ²’é–‹æˆï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚"), 50);
            koCoughed = true; return; 
        }

        if (checkBoatEvents(onBoat)) { flushDeaths(); render(); return; }

        const hasDriver = onBoat.some(c => c.canDrive);
        const fu = onBoat.find(c => c.id === 'fuqunzhu');
        const ye = onBoat.find(c => c.id === 'yeyuanzhi');
        const orange = onBoat.find(c => c.id === 'orange');

        if (ko && ko.isBald && (!orange || !orange.canDrive)) {
            log(`[æŸ¯æ–‡å“²] ä¸ä¿¡ä»»å…¶ä»–äººï¼Œå …æŒè¦æ©˜å­é–‹èˆ¹æ‰è‚¯èµ°ã€‚`, true);
            return;
        }
        const kmtCount = chars.filter(c => c.location === 'taiwan' && c.isAlive && !c.isJailed && c.type === 'kmt').length;
        if (ko && kmtCount > 5 && boatLoc === 'taiwan') {
            log(`[æŸ¯æ–‡å“²] è¢«åœ‹æ°‘é»¨åˆé›£ï¼šã€Œæ°‘èª¿ç¬¬äºŒå…ˆåˆ¥èµ°ï¼ã€èˆ¹è¢«æ””ä¸‹ã€‚`, true);
            return;
        }
        if (fu && !hasDriver) {
            log(`[å‚…å´‘è]ï¼šã€Œéƒ½æ˜¯ä¸­å¤®çš„éŒ¯ï¼ã€ç¡¬è¦é–‹èˆ¹...`);
            handleSink('fu_drive'); return;
        }
        if (!fu && !hasDriver) {
            if(ye) log(`[è‘‰å…ƒä¹‹] ç‘Ÿç‘Ÿç™¼æŠ–...`);
            else handleNoDriver(onBoat);
            return; 
        }

        const target = (boatLoc === 'taiwan') ? 'china' : 'taiwan';
        boatLoc = target;
        if (target === 'china') tripCount++;

        updateBoatUI();
        log(`ğŸŒŠ èˆ¹é–‹å¾€ ${target==='china'?'ä¸­åœ‹':'å°ç£'}...`, true);
        koCoughed = false;

        setTimeout(arriveLogic, 1000);
    }

    function handleNoDriver(onBoat) {
        const speakers = onBoat.filter(c => ['xuxiaoqin','wanghongwei','wengxiaoling','fuqunzhu'].includes(c.id));
        if (speakers.length > 0) {
            const s = speakers[Math.floor(Math.random()*speakers.length)];
            let msg = "èˆ¹ä¸å‹•...";
            if(s.id === 'xuxiaoqin') msg = "å¸æ©Ÿå‘¢ï¼Ÿæ˜¯ä¸æ˜¯èº²èµ·ä¾†äº†ï¼Ÿæˆ‘è¦æ‹¿å‡ºå¯†éŒ„å™¨æ­ç™¼é€™å€‹å¼Šæ¡ˆï¼";
            if(s.id === 'wanghongwei') msg = "èˆ¹ä¸å‹•ï¼Ÿé€™èƒŒå¾Œä¸€å®šæœ‰ä¸å¯å‘Šäººçš„æ”¿å•†å‹¾çµï¼æˆ‘è¦ç«‹åˆ»å¬é–‹è¨˜è€…æœƒï¼";
            if(s.id === 'wengxiaoling') msg = "æˆ‘ä»¥ç«‹æ³•é™¢æœ€é«˜æ¬ŠåŠ›å‘½ä»¤é€™è‰˜èˆ¹ï¼šé¦¬ä¸Šé–‹å‹•ï¼æˆ‘æ˜¯ç«‹å§”ï¼Œæˆ‘æ¯”ä½ å¤§ï¼";
            if(s.id === 'fuqunzhu') msg = "é€£èˆ¹éƒ½è¢«å¡ï¼Ÿé€™æ˜é¡¯æ˜¯æ°‘é€²é»¨ä¸­å¤®æ”¿åºœåœ¨æ‰“å£“æˆ‘å€‘èŠ±è“®äººï¼";
            log(`[${s.name}]ï¼šã€Œ${msg}ã€`, true);
        } else {
            log("ç„¡äººé§•é§›ï¼Œèˆ¹åœ¨åŸåœ°æ‰“è½‰ã€‚", true);
        }
    }

    function arriveLogic() {
        if(isGameOver) return;
        const onBoat = chars.filter(c => c.location === 'boat');
        const ko = chars.find(c => c.id === 'kowenje');
        const peggy = chars.find(c => c.id === 'peggy');

        // è‡ªå‹•ä¸‹èˆ¹: æŠµé”ç¬é–“æ›´æ–°ä½ç½®
        onBoat.forEach(c => {
            if(c.isAlive) c.location = boatLoc;
        });
        render();

        if (includeTPP && ko && ko.isJailed && peggy && peggy.location === 'taiwan' && peggy.isAlive && !peggy.isJailed) {
            if (koSavings < 1.2) {
                koSavings += 0.1;
                koSavings = Math.round(koSavings * 10) / 10;
                log(`[é™³ç®çª] è½‰å¸³ 1000 è¬æ•‘å¤«ï¼(æŸ¯ç´¯ç©: ${koSavings.toFixed(1)}å„„)`);
            } else if (!peggySaidNoMore) {
                setTimeout(() => alert("é™³ç®çªï¼šã€Œè²·è±ªå®…çš„éŒ¢éƒ½åœ¨é€™äº†ï¼Œæ²’äº†ã€‚ã€(åœæ­¢è½‰å¸³)"), 100);
                peggySaidNoMore = true;
            }
        }

        if (boatLoc === 'china') {
            if (includeTPP) {
                const huang = chars.find(x => x.id === 'huangkuochang');
                // é»ƒåœ‹æ˜Œçˆ†æ–™
                if (tripCount <= 5 && huang && huang.location === 'taiwan' && onBoat.length > 1 && gossipCount < 3) {
                    if (Math.random() < 0.6) {
                        let candidates = onBoat.filter(c => GOSSIP_DB[c.id]);
                        let victim = null;
                        if (candidates.length > 0) {
                            let nonDrivers = candidates.filter(c => !c.canDrive);
                            if (nonDrivers.length > 0) victim = nonDrivers[Math.floor(Math.random() * nonDrivers.length)];
                            else victim = candidates[Math.floor(Math.random() * candidates.length)];
                        }

                        if (victim) {
                            // SafeKill
                            const driversInChina = chars.filter(c => c.location === 'china' && c.isAlive && c.canDrive && c.id !== victim.id);
                            if (driversInChina.length === 0) {
                                log(`[é»ƒåœ‹æ˜Œ] çˆ†æ–™äº† ${victim.name}ï¼Œä½†ç‚ºäº†è®“èˆ¹å›ä¾†ï¼Œæš«æ™‚æ”¾éä»–ã€‚`, true);
                                registerArrival(victim);
                            } else {
                                const gossip = GOSSIP_DB[victim.id];
                                log(`[é»ƒåœ‹æ˜Œ] ç‹—ä»”çˆ†æ–™ï¼š${victim.name}${gossip}ï¼`, true);
                                log(`ä¸­åœ‹äººæ°‘éœ‡æ€’ï¼Œå°‡ ${victim.name} æ¨ä¸‹æµ·ã€‚`);
                                kill(victim.id, 'è¢«ç‹—ä»”çˆ†æ–™æ¨ä¸‹æµ·');
                                gossipCount++;
                                log(`[é»ƒåœ‹æ˜Œ] å–ƒå–ƒè‡ªèªï¼šã€Œæˆ‘æ‰‹ä¸Šé‚„æœ‰ ${3 - gossipCount} å¼µç‰Œå¯ä»¥æ‰“...ã€`);
                            }
                            // å…¶ä»–äºº
                            onBoat.filter(c => c.id !== victim.id).forEach(c => registerArrival(c));
                        } else {
                            onBoat.forEach(c => registerArrival(c));
                        }
                    } else {
                        onBoat.forEach(c => registerArrival(c));
                    }
                } else {
                    onBoat.forEach(c => registerArrival(c));
                }
            } else {
                onBoat.forEach(c => registerArrival(c));
            }

            const guan = chars.find(x => x.id === 'guanchang');
            if (guan && guan.location === 'china' && guan.isAlive) {
                const propaganda = ["ä¸­åœ‹æœ‰è‡ªå‹•è²©è³£æ©Ÿï¼", "ä¸­åœ‹å»æ‰€æœ‰é–€ï¼", "ä¸­åœ‹é«˜éµæœ‰é èƒŒï¼", "å°ç£çå¥¶800ä½ æ•¢ä¿¡ï¼Ÿ"];
                const idx = (chinaArrivals.length % 4); 
                log(`[é¤¨é•·]ï¼šã€Œ${propaganda[idx]}ã€`, true);
                if (idx === 3) safeKill('guanchang', 'é€ è¬ è¢«æ¨ä¸‹æµ·');
            }
        }

        // ç™»è¨˜æŠµé”
        chars.filter(c => c.location === 'china' && c.isAlive).forEach(c => {
            if (!chinaArrivals.includes(c.id)) {
                chinaArrivals.push(c.id);
                log(`${c.name} æŠµé”ä¸­åœ‹ã€‚`);
                if (c.id === 'zhengliwen' && chinaArrivals.length > 5) {
                    log(`[é„­éº—æ–‡]ï¼šã€Œå¤ªæ™šåˆ°äº†ï¼æ°£æ­»ï¼ã€`);
                    handleSink('zheng_late');
                }
            }
        });

        checkShoreEvents();
        if(includeTPP) checkBetrayal();
        if(includeTPP) checkOrangeSpawn();
        
        flushDeaths();
        checkWin();
    }

    function registerArrival(c) {
        if (c.isAlive && !chinaArrivals.includes(c.id)) {
            chinaArrivals.push(c.id);
            log(`${c.name} æŠµé”ä¸­åœ‹ã€‚`);
            if (c.id === 'zhengliwen' && chinaArrivals.length > 5) {
                log(`[é„­éº—æ–‡]ï¼šã€Œå¤ªæ™šåˆ°äº†ï¼æ°£æ­»ï¼ã€`);
                handleSink('zheng_late');
            }
        }
    }

    function checkBoatEvents(onBoat) {
        const ids = onBoat.map(c => c.id);
        const has = (id) => ids.includes(id);
        const orange = onBoat.find(c => c.id === 'orange');
        const luo = onBoat.find(c => c.id === 'luozhiqiang');

        if (orange && luo) {
            log(`[æ©˜å­] ä¸ä»˜éŒ¢ï¼Œç›´æ¥æŠŠç¾…æ™ºå¼·æ¨ä¸‹æµ·ï¼`, true);
            kill('luozhiqiang', 'è¢«æ©˜å­æ¨ä¸‹æµ·');
            return true;
        }

        if (has('wanghongwei') && has('xuxiaoqin')) {
            log(`[ç‹é´»è–‡] èˆ‡ [å¾å·§èŠ¯] ä¸€è¨€ä¸åˆï¼ŒæŠŠå¾æ¨ä¸‹èˆ¹ï¼`, true);
            kill('xuxiaoqin', 'è¢«ç‹é´»è–‡æ¨ä¸‹æµ·');
            return true;
        }
        
        const wang = onBoat.find(c => c.id === 'wanghongwei');
        if (!hasWangKilled && wang) {
            const kmtMan = onBoat.find(c => KMT_MALE_IDS.includes(c.id));
            if (kmtMan) {
                 log(`[ç‹é´»è–‡] è¦ºå¾—è¢« [${kmtMan.name}] é¨·æ“¾ï¼Œç›´æ¥å°‡ä»–æ¨ä¸‹æµ·ï¼`, true);
                 kill(kmtMan.id, 'è¢«ç‹é´»è–‡æ¨ä¸‹æµ·');
                 hasWangKilled = true;
                 return true;
            }
        }

        if (includeTPP) {
            const huang = chars.find(c => c.id === 'huangkuochang');
            const ye = onBoat.find(c => c.id === 'yeyuanzhi');
            if (boatLoc === 'taiwan' && huang && huang.location === 'taiwan' && ye) {
                log(`[é»ƒåœ‹æ˜Œ] å’†å“®ï¼è‘‰å…ƒä¹‹åš‡å¾—æ‰é€²æµ·è£¡ã€‚`, true);
                kill('yeyuanzhi', 'è¢«é»ƒåœ‹æ˜Œå’†å“®åš‡è½æµ·');
                return true;
            }

            if (luo && onBoat.length === 2) {
                const other = onBoat.find(c => c.id !== 'luozhiqiang');
                if (other.id === 'kowenje') {
                    log(`[æŸ¯æ–‡å“²]ï¼šã€ŒéŒ¢éƒ½åœ¨ç®çªé‚£ã€‚ã€ç¾…æ™ºå¼·æ”¶ä¸åˆ°éŒ¢æ°£æ­»ï¼`, true);
                    if(Math.random()>0.5) kill('kowenje', 'è¢«ç¾…æ™ºå¼·æ¨ä¸‹æµ·');
                    else kill('luozhiqiang', 'æ°£æ€¥æ”»å¿ƒè½æµ·');
                    return true;
                }
            }
        }

        if (luo && onBoat.length === 2) {
            const other = onBoat.find(c => c.id !== 'luozhiqiang');
            if (other.money <= 0) {
                log(`[${other.name}] èº«ç„¡åˆ†æ–‡è¢«å¼·è¿«è²·æ›¸ï¼Œæ†¤è€Œå°‡ç¾…æ™ºå¼·æ¨ä¸‹æµ·ï¼`, true);
                kill('luozhiqiang', `è¢« ${other.name} æ¨ä¸‹æµ·`);
                return true;
            }
            other.money -= 100; luo.money += 100;
            log(`ç¾…æ™ºå¼·è³£æ›¸è³ºäº† ${other.name} 100è¬ã€‚`);
            render();
        }
        
        if (has('fuqunzhu') && !has('zhulilun')) {
            if (has('hanguoyu')) { log(`[éŸ“åœ‹ç‘œ] å°‡å‚…å´‘èæ¨ä¸‹æµ·ã€‚`); kill('fuqunzhu', 'èˆ¹ä¸Šè¢«éŸ“æ¨ä¸‹æµ·'); return true; }
            if (has('mayingjeou')) { log(`[é¦¬è‹±ä¹] æ–½å±•æ­»äº¡ä¹‹æ¡ã€‚`); kill('fuqunzhu', 'èˆ¹ä¸Šè¢«é¦¬æ¨ä¸‹æµ·'); return true; }
        }

        return false;
    }

    function checkShoreEvents() {
        if (isGameOver) return;
        
        const tw = chars.filter(c => c.location === 'taiwan' && c.isAlive && !c.isJailed);
        const hasTw = (id) => tw.some(c => c.id === id);

        if (includeTPP) {
            const huang = chars.find(x => x.id === 'huangkuochang');
            const ko = chars.find(x => x.id === 'kowenje');
            const peggy = chars.find(x => x.id === 'peggy');
            const isInvincible = (ko && ko.location === 'china' && peggy && peggy.location === 'china' && peggy.isAlive);

            if (!hasCaseTriggered && !isInvincible && huang && ko && huang.isAlive && ko.isAlive && !ko.isJailed && huang.location !== ko.location && ko.location !== 'boat') {
                hasCaseTriggered = true;
                log(`[é»ƒåœ‹æ˜Œ] å’†å“®æŒ‡æ§ï¼å‡±æ€åœ‹éš›çˆ†æ–™æŸ¯æ–‡å“²ï¼`, true);
                if (ko.location === 'china') {
                    log(`æŸ¯æ–‡å“²åœ¨ä¸­åœ‹è¢«åˆ¤æ­»åˆ‘ï¼`);
                    kill('kowenje', 'ä¸­åœ‹è²ªæ±¡æ­»åˆ‘');
                } else {
                    log(`æŸ¯æ–‡å“²åœ¨å°ç£è¢«åˆ¤23å¹´ï¼`);
                    ko.isJailed = true; ko.isBald = true;
                    render();
                }
            }

            if (hasTw('wuyihsuan')) {
                if (!hasWuComplained) {
                    if(Math.random()>0.7) {
                        log(`[å³æ€¡è±]ï¼šã€Œç¾åœ¨æ˜¯æ€éº¼æ¨£ï¼Ÿï¼ã€`);
                        hasWuComplained = true;
                    }
                } else {
                    const killer = tw.find(c => ['zhengliwen','xuxiaoqin','wanghongwei'].includes(c.id));
                    if (killer && !hasTw('kowenje') && !hasTw('huangkuochang')) {
                        log(`[${killer.name}]ï¼šã€Œç¾åœ¨å°±é€™æ¨£ï¼ã€æŠŠå³æ€¡è±æ¨ä¸‹æµ·ã€‚`, true);
                        kill('wuyihsuan', 'è¢«KMTå¥³å°‡æ¨ä¸‹æµ·');
                    }
                }
            }
            
            if (hasTw('guanchang')) {
                const msgs = ["è²·ä¾¿ç•¶æ€æ²’æ‰¾æˆ‘ï¼Ÿ", "åšè¡£æœæ€æ²’æ‰¾æˆ‘ï¼Ÿ", "æˆ‘è®Šä¸­åœ‹å¥èº«æˆ¿äº†ï¼Ÿ", "æˆ‘åªæœ‰ä¸‰å…¬åˆ†..."];
                if(Math.random()>0.7) log(`[é¤¨é•·]ï¼šã€Œ${msgs[Math.floor(Math.random()*msgs.length)]}ã€`);
            }

            if (hasTw('huangkuochang') && boatLoc === 'china') {
                log(`[é»ƒåœ‹æ˜Œ]ï¼šã€Œæˆ‘é‚„æ²’ä¸Šèˆ¹ï¼ï¼ï¼ã€`, true);
            }
        }

        if (hasTw('wanghongwei') && !tw.some(c=>WANG_PROTECTORS.includes(c.id))) {
             const v = tw.find(c=>KMT_MALE_IDS.includes(c.id) && c.id!=='fuqunzhu');
             if(!hasWangKilled && v) { 
                 log(`[ç‹é´»è–‡] å²¸ä¸Šå¤±æ§ï¼Œæ¨äººä¸‹æµ·ï¼`); 
                 kill(v.id, 'è¢«ç‹é´»è–‡æ¨ä¸‹æµ·'); 
                 hasWangKilled = true;
             }
        }
        
        if (hasTw('fuqunzhu') && !hasTw('zhulilun')) {
            if (hasTw('hanguoyu')) kill('fuqunzhu', 'å²¸ä¸Šè¢«éŸ“æ¨ä¸‹æµ·');
            else if (hasTw('mayingjeou')) kill('fuqunzhu', 'å²¸ä¸Šè¢«é¦¬æ¨ä¸‹æµ·');
        }

        const cn = chars.filter(c => c.location === 'china' && c.isAlive);
        const hasCn = (id) => cn.some(c => c.id === id);
        
        if (hasCn('wengxiaoling') && !hasCn('fuqunzhu') && !hasCn('zhengliwen')) {
            log(`[ç¿æ›‰ç²] ç½µè§£æ”¾è»ã€Œæ¯”ä½ å¤§ã€ï¼Œè¢«æ¨ä¸‹æµ·ã€‚`, true);
            safeKill('wengxiaoling', 'ä¸­åœ‹è½å–®è¢«æ®º');
        }

        if (includeTPP && hasCn('kowenje')) {
            const peggy = chars.find(x => x.id === 'peggy');
            const isInvincible = (peggy && peggy.location === 'china' && peggy.isAlive);
            
            if (!isInvincible) {
                const victim = cn.find(c => !['kowenje','huangkuochang','peggy','guanchang','wuyihsuan','orange'].includes(c.id));
                if (victim) {
                    log(`[æŸ¯æ–‡å“²] å–Šã€Œå…©å²¸ä¸€å®¶è¦ªã€ï¼Œæƒ³æŠŠ ${victim.name} æ¨ä¸‹æµ·...`, true);
                    safeKill(victim.id, 'è¢«æŸ¯æ–‡å“²èƒŒåˆº');
                }
            }
        }
    }

    function checkBetrayal() {
        const twKMT = chars.filter(c => c.location === 'taiwan' && c.type === 'kmt' && c.isAlive).length;
        const twTPP = chars.filter(c => c.location === 'taiwan' && c.type === 'tpp' && c.isAlive).length;

        if (twKMT === 0 && twTPP > 0) {
            log("åœ‹æ°‘é»¨éæ²³æ‹†æ©‹ï¼èˆ‰å ±æ°‘çœ¾é»¨å›åœ‹ï¼");
            chars.filter(c => c.location === 'taiwan' && c.type === 'tpp' && c.isAlive).forEach(c => {
                kill(c.id, 'è¢«KMTèˆ‰å ±å›åœ‹è™•æ±º');
            });

            const guan = chars.find(x => x.id === 'guanchang');
            if (guan && guan.location === 'china' && guan.isAlive) {
                const kmtTargets = chars.filter(c => c.location === 'china' && c.type === 'kmt' && c.isAlive);
                if (kmtTargets.length > 0) {
                    const v = kmtTargets[Math.floor(Math.random() * kmtTargets.length)];
                    log(`[é¤¨é•·] æš´æ€’å¾©ä»‡ï¼Œå°‡ ${v.name} æ¨ä¸‹æµ·ï¼`);
                    kill(v.id, 'è¢«é¤¨é•·å¾©ä»‡æ¨ä¸‹æµ·');
                }
                log(`[é¤¨é•·] éš¨å³è¢«è§£æ”¾è»æ§æ±ºã€‚`);
                kill('guanchang', 'è¢«è§£æ”¾è»æ§æ±º');
            }

            const huang = chars.find(x => x.id === 'huangkuochang');
            if (huang && huang.location === 'china' && huang.isAlive) {
                log(`[é»ƒåœ‹æ˜Œ] ç™¼è¡¨å®£è¨€åŠ å…¥åœ‹æ°‘é»¨ï¼`);
                const zheng = chars.find(x => x.id === 'zhengliwen');
                if (zheng && zheng.location === 'china' && zheng.isAlive) {
                    log(`[é»ƒåœ‹æ˜Œ] ç‚ºäº†ç«‹å¨ï¼Œç™¼å‹•ç‹—ä»”æ”»æ“Šé„­éº—æ–‡ï¼`);
                    kill('zhengliwen', 'è¢«é»ƒåœ‹æ˜Œç»ç¥­');
                } else {
                    const kmtFemales = chars.filter(c => c.location === 'china' && c.type === 'kmt' && c.gender === 'f' && c.isAlive);
                    if (kmtFemales.length > 0) {
                        const v = kmtFemales[Math.floor(Math.random()*kmtFemales.length)];
                        log(`[é»ƒåœ‹æ˜Œ] æ‰¾ä¸åˆ°é„­éº—æ–‡ï¼Œéš¨æ‰‹æ”»æ“Š ${v.name}ï¼`);
                        kill(v.id, 'è¢«é»ƒåœ‹æ˜Œç»ç¥­');
                    } else {
                        log(`[é»ƒåœ‹æ˜Œ] æš—è‡ªç›¤ç®—ç«¶é¸åœ‹æ°‘é»¨ä¸»å¸­ã€‚`);
                    }
                }
            }
        }
    }

    function checkOrangeSpawn() {
        const ko = chars.find(x => x.id === 'kowenje');
        const orange = chars.find(x => x.id === 'orange');
        const twCount = chars.filter(c => c.location === 'taiwan' && c.isAlive && !c.isJailed).length;
        
        if (ko && ko.isJailed && twCount <= 6 && !orange) {
            setTimeout(() => alert("ğŸŠ æ©˜å­å¸¶è‘— 3.5 å„„ç¾èº«å°ç£æ•‘æ´é˜¿åŒ—ï¼"), 100);
            log(`ğŸŠ [æ©˜å­] å¸¶è‘—3.5å„„ç¾èº«å°ç£æ•‘æ´é˜¿åŒ—ï¼`, true);
            chars.push(JSON.parse(JSON.stringify(ORANGE_DATA)));
            chars.find(x=>x.id==='orange').location = 'taiwan';
            chars.find(x=>x.id==='orange').isAlive = true;
        }
    }

    function safeKill(id, reason) {
        const driversInChina = chars.filter(c => c.location === 'china' && c.isAlive && c.canDrive && c.id !== id);
        
        if (driversInChina.length === 0) {
            log(`(ç³»çµ±) ç‚ºäº†é¿å…èˆ¹éš»æ“±æ·ºï¼Œ${chars.find(x=>x.id===id).name} é€ƒéä¸€åŠ«ã€‚`);
        } else {
            kill(id, reason);
        }
    }

    function handleSink(reasonCode) {
        isGameOver = true;
        let msg = "";
        if (reasonCode === 'fu_drive') msg = "å‚…å´‘èç¡¬è¦æŒèˆµï¼Œå°è‡´æ²ˆèˆ¹";
        else if (reasonCode === 'zheng_late') msg = "é„­éº—æ–‡é²åˆ°æš´æ€’ï¼Œå¼„æ²‰èˆ¹éš»";
        else msg = reasonCode;

        log(`âŒ ${msg}ï¼Œå…¨å“¡è½æµ·ï¼`, true);
        chars.filter(c => c.location === 'boat').forEach(c => kill(c.id, msg, false));
        
        const cnAlive = chars.filter(c => c.location === 'china' && c.isAlive);
        if (cnAlive.length < 5) {
            log(`äººæ•¸ä¸è¶³ï¼Œè§£æ”¾è»æ¸…å ´ï¼ä¸­åœ‹å²¸ä¸Šå…¨å“¡è™•æ±ºï¼`, true);
            cnAlive.forEach(c => kill(c.id, 'è¢«è§£æ”¾è»æ¨ä¸‹æµ·', false));
        }

        const cnFinal = chars.filter(c => c.location === 'china' && c.isAlive).length;
        if (cnFinal === 0) {
            log(`æŠ•èª è¨ˆç•«å¾¹åº•å¤±æ•—ï¼Œç•™åœ¨å°ç£çš„æˆå“¡è¢«åˆ¤å›åœ‹ç½ªè™•ä»¥æ¥µåˆ‘ï¼`, true);
            chars.filter(c => c.location === 'taiwan' && c.isAlive).forEach(c => {
                 kill(c.id, 'å›åœ‹ç½ªæ­»åˆ‘', false);
            });
        }
        flushDeaths();
        render();
        
        setTimeout(() => {
            if (chars.filter(c => c.isAlive).length === 0) {
                endGame("åœ‹çœ¾å…©é»¨æ»…äº¡ï¼å°ç£äººæ°‘çš„å‹åˆ©ï¼");
            } else {
                setTimeout(() => alert("éŠæˆ²çµæŸ (æ²ˆèˆ¹)"), 100);
            }
        }, 500);
    }

    function kill(id, reason, showLog=true) {
        const c = chars.find(x => x.id === id);
        if (c && c.isAlive) {
            c.isAlive = false;
            c.location = 'dead';
            if(showLog) log(`ğŸ’€ ${c.name} æ­»äº¡ (${reason})`);
            deathQueue.push(`${c.name} (${reason})`);
            render();
        }
    }

    function flushDeaths() {
        if (deathQueue.length > 0) {
            const msg = "ğŸ’€ æ­»äº¡é€šçŸ¥ï¼š\n" + deathQueue.join("\n");
            setTimeout(() => alert(msg), 100);
            deathQueue = [];
        }
    }

    function checkWin() {
        if(isGameOver) return;

        const alive = chars.filter(c => c.isAlive);
        const twActive = chars.filter(c => c.location === 'taiwan' && c.isAlive && !c.isJailed);
        const boatActive = chars.filter(c => c.location === 'boat' && c.isAlive && !c.isJailed);
        
        if (twActive.length === 0 && boatActive.length === 0) {
             const cnAlive = chars.filter(c => c.location === 'china' && c.isAlive).length;
             if (cnAlive < 5) {
                 log(`æŠ•èª äººæ•¸ä¸è¶³ï¼Œä¸­åœ‹å…¨æ»…ï¼Œå°ç£å›åœ‹ç½ªè™•æ­»ï¼`, true);
                 chars.forEach(c => { if(c.isAlive) kill(c.id, 'å›åœ‹ç½ªæ­»åˆ‘', false); });
                 endGame("åœ‹çœ¾å…©é»¨æ»…äº¡ï¼å°ç£äººæ°‘çš„å‹åˆ©ï¼");
             } else {
                 endGame(`æˆåŠŸæ’¤é›¢ ${cnAlive} äººï¼åœ‹æ°‘é»¨å‹åˆ©ï¼`);
             }
             return;
        }

        if (alive.length === 0) {
            endGame("åœ‹çœ¾å…©é»¨æ»…äº¡ï¼å°ç£äººæ°‘çš„å‹åˆ©ï¼");
            return;
        }
        
        const allInChina = alive.every(c => c.location === 'china');
        if (allInChina) {
            if (alive.length >= 5) endGame(`æˆåŠŸæ’¤é›¢ ${alive.length} äººï¼åœ‹æ°‘é»¨å‹åˆ©ï¼`);
            else {
                 log(`äººæ•¸ä¸è¶³ï¼Œå…¨éƒ¨æ¨ä¸‹æµ·ï¼`);
                 alive.forEach(c => kill(c.id, 'äººæ•¸ä¸è¶³è™•æ­»', false));
                 endGame("åœ‹çœ¾å…©é»¨æ»…äº¡ï¼å°ç£äººæ°‘çš„å‹åˆ©ï¼");
            }
        }
    }

    function endGame(msg) {
        isGameOver = true;
        flushDeaths();
        log(`=== ${msg} ===`, true);
        
        if (msg.includes("å°ç£äººæ°‘çš„å‹åˆ©")) {
            setTimeout(() => {
                alert(msg);
                celebrateVictory();
            }, 500);
        } else {
            setTimeout(() => alert(msg), 500);
        }

        const btn = document.getElementById('btn-move');
        btn.textContent = "è«‹æŒ‰é‡ç½®";
        btn.style.background = "#999";
        btn.disabled = true;
    }

    function celebrateVictory() {
        document.body.classList.add('victory-mode');
        document.getElementById('victory-overlay').style.display = 'flex';
    }

    function getBoatSize() { return chars.filter(c => c.location === 'boat').reduce((a,b)=>a+b.size,0); }
    function updateBoatUI() {
        const b = document.getElementById('boat');
        if (boatLoc === 'taiwan') { b.classList.add('at-taiwan'); b.classList.remove('at-china'); }
        else { b.classList.add('at-china'); b.classList.remove('at-taiwan'); }
    }
    function log(msg, highlight = false) {
        const ul = document.getElementById('log-list');
        const li = document.createElement('li');
        li.className = 'log-item';
        if (highlight) li.classList.add('log-highlight');
        const time = new Date().toLocaleTimeString('en-US', {hour12:false});
        li.innerHTML = `<span class="log-time">[${time}]</span>${msg}`;
        ul.prepend(li);
    }

    startNewGame();
</script>
</body>
</html>
