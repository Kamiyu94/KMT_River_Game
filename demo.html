<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹æ°‘é»¨ç«‹å§”éæ²³ V3.0</title>
    <style>
        /* --- CSS æ¨£å¼é–‹å§‹ --- */
        :root {
            --sea-color: #80deea;
            --taiwan-green: #66bb6a;
            --china-gray: #bdbdbd;
            --boat-brown: #795548;
            --ui-bg: rgba(255, 255, 255, 0.95);
        }

        body {
            margin: 0;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: var(--sea-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* é˜²æ­¢æ²å‹• */
        }

        /* éŠæˆ²ä¸»èˆå° */
        #stage {
            flex: 1;
            position: relative;
            width: 100%;
            display: flex;
            justify-content: space-between;
            overflow: hidden;
        }

        /* èƒŒæ™¯åœ°åœ– (SVG) */
        .map-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°ä¸‹æ–¹ */
        }

        /* å·¦å²¸ (ä¸­åœ‹) */
        #area-china {
            position: relative;
            width: 25%;
            height: 100%;
            z-index: 10;
            padding-top: 60px; /* é¿é–‹æ–‡å­— */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* å³å²¸ (å°ç£) */
        #area-taiwan {
            position: relative;
            width: 25%;
            height: 100%;
            z-index: 10;
            padding-top: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* è§’è‰²å®¹å™¨ */
        .char-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }

        /* æ²³é“èˆ‡èˆ¹ */
        #area-river {
            flex: 1;
            position: relative;
            z-index: 20;
        }

        #boat {
            width: 160px;
            height: 70px;
            background-color: var(--boat-brown);
            border-radius: 0 0 40px 40px;
            border-top: 5px solid #5d4037;
            position: absolute;
            bottom: 20%;
            /* é€é JS æ§åˆ¶ left */
            left: calc(100% - 200px); 
            transition: left 1.5s cubic-bezier(0.45, 0.05, 0.55, 0.95);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* è§’è‰²ç«™åœ¨èˆ¹ç·£ */
            gap: 5px;
            padding-top: 5px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        #boat::after {
            content: "ä¹˜è¼‰: 2äºº";
            position: absolute;
            bottom: 5px;
            font-size: 10px;
            color: rgba(255,255,255,0.5);
        }
        
        /* èˆ¹ä¸Šæœ‰è£é£¾ç”¨çš„æ——å¹Ÿ */
        .flag {
            position: absolute;
            top: -25px;
            right: 10px;
            width: 2px;
            height: 25px;
            background: #333;
        }
        .flag::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 20px;
            height: 15px;
            background: red;
            clip-path: polygon(0 0, 100% 50%, 0 100%);
        }

        /* è§’è‰²å¡ç‰‡ */
        .char {
            width: 55px;
            height: 55px;
            background: white;
            border: 2px solid #333;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            user-select: none;
        }

        .char:active { transform: scale(0.9); }

        /* é™³ç‰çç‰¹æ®Šæ¨£å¼ */
        .char[data-id="chenyuzhen"] {
            border: 4px solid #ff9800;
            width: 60px;
            height: 60px;
        }

        .char-img { font-size: 24px; }
        .char-info { 
            font-size: 9px; 
            background: rgba(0,0,0,0.1); 
            padding: 0 4px; 
            border-radius: 4px;
            margin-top: 2px;
        }

        /* å°è©±æ³¡æ³¡ */
        .bubble {
            position: absolute;
            bottom: 65px; /* åœ¨è§’è‰²é ­ä¸Š */
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: #fff;
            border: 2px solid #000;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            opacity: 0;
            transition: all 0.3s ease-out;
            pointer-events: none;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.2);
        }

        .bubble.show {
            transform: translateX(-50%) scale(1);
            opacity: 1;
        }

        .bubble::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            margin-left: -6px;
            border-width: 6px 6px 0;
            border-style: solid;
            border-color: #000 transparent transparent transparent;
        }

        /* ç‹€æ…‹é¢æ¿ (Log & Controls) */
        #dashboard {
            height: 220px;
            background: var(--ui-bg);
            border-top: 3px solid #333;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            z-index: 50;
        }

        #info-panel {
            flex: 1;
            display: flex;
            gap: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        #log-box, #death-box {
            flex: 1;
            border: 1px solid #ccc;
            background: #fff;
            padding: 5px;
            overflow-y: auto;
            font-size: 12px;
            border-radius: 4px;
        }
        
        #log-box h4, #death-box h4 { margin: 0 0 5px 0; text-align: center; background: #eee; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { border-bottom: 1px dashed #eee; padding: 2px 0; }
        
        .log-time { color: #888; font-size: 10px; margin-right: 4px; }

        #controls {
            height: 50px;
            display: flex;
            gap: 10px;
        }

        button {
            flex: 1;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }

        button:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }
        
        #btn-move { background: #e53935; flex: 2; font-size: 20px; }
        #btn-reset { background: #607d8b; }

        /* åœ°åæ¨™ç±¤ */
        .label-geo {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        /* æ‰‹æ©Ÿé©é…å¾®èª¿ */
        @media (max-width: 600px) {
            #boat { width: 130px; height: 60px; }
            .char { width: 45px; height: 45px; }
            .char-img { font-size: 20px; }
        }
    </style>
</head>
<body>

    <div id="stage">
        <svg class="map-layer" viewBox="0 0 800 600" preserveAspectRatio="none">
            <path d="M-50,0 L200,0 L180,100 L220,200 L150,300 L200,400 L160,600 L-50,600 Z" fill="#e0e0e0" stroke="#9e9e9e" stroke-width="2"/>
            
            <path d="M650,50 Q700,20 750,80 Q820,200 780,350 Q750,500 700,550 Q600,450 620,300 Q630,150 650,50 Z" fill="#66bb6a" stroke="#2e7d32" stroke-width="2"/>
        </svg>

        <div id="area-china">
            <div class="label-geo" style="color:#555">ä¸­åœ‹<br><span style="font-size:12px">China</span></div>
            <div id="chars-china" class="char-container"></div>
        </div>

        <div id="area-river">
            <div id="boat">
                <div class="flag"></div>
                </div>
        </div>

        <div id="area-taiwan">
            <div class="label-geo">å°ç£<br><span style="font-size:12px">Taiwan</span></div>
            <div id="chars-taiwan" class="char-container"></div>
        </div>
    </div>

    <div id="dashboard">
        <div id="info-panel">
            <div id="death-box">
                <h4>ğŸ’€ æ­»äº¡åå–®</h4>
                <ul id="list-dead"></ul>
            </div>
            <div id="log-box">
                <h4>ğŸ“œ éŠæˆ²æ—¥èªŒ</h4>
                <ul id="list-log"></ul>
            </div>
        </div>
        <div id="controls">
            <button id="btn-reset" onclick="initGame()">é‡ç½®</button>
            <button id="btn-move" onclick="moveBoat()">ğŸš¢ é–‹èˆ¹ (GO)</button>
        </div>
    </div>

    <script>
        // --- éŠæˆ²é‚è¼¯ (Script) ---

        // 1. è§’è‰²èˆ‡åƒæ•¸è¨­å®š
        // æ‚¨å¯ä»¥è‡ªç”±æ›´æ› Emoji æˆ–å°‡ä¾†æ›¿æ›æˆ <img>
        const INITIAL_CHARS = [
            { id: 'hanguoyu', name: 'éŸ“åœ‹ç‘œ', emoji: 'ğŸŸ', money: 200, canDrive: true, size: 1 },
            { id: 'fuqunzhu', name: 'å‚…å´‘è', emoji: 'ğŸ‘‘', money: 500, canDrive: false, size: 1 },
            { id: 'zhulilun', name: 'æœ±ç«‹å€«', emoji: 'ğŸ¤“', money: 200, canDrive: true, size: 1 },
            { id: 'xuxiaoqin', name: 'å¾å·§èŠ¯', emoji: 'ğŸ', money: 200, canDrive: false, size: 1 },
            { id: 'zhengliwen', name: 'é„­éº—æ–‡', emoji: 'ğŸ‘ ', money: 200, canDrive: true, size: 1 },
            { id: 'wanghongwei', name: 'ç‹é´»è–‡', emoji: 'ğŸ’£', money: 200, canDrive: false, size: 1 },
            { id: 'luozhiqiang', name: 'ç¾…æ™ºå¼·', emoji: 'ğŸ“–', money: 100, canDrive: true, size: 1 }, // é‡‘é¡ä¿®æ­£ç‚º 100
            { id: 'chenyuzhen', name: 'é™³ç‰ç', emoji: 'ğŸ›¡ï¸', money: 200, canDrive: true, size: 2 },
            { id: 'yeyuanzhi', name: 'è‘‰å…ƒä¹‹', emoji: 'ğŸ˜¨', money: 200, canDrive: false, size: 1 },
            { id: 'wengxiaoling', name: 'ç¿æ›‰ç²', emoji: 'âš–ï¸', money: 200, canDrive: false, size: 1 },
            { id: 'mayingjeou', name: 'é¦¬è‹±ä¹', emoji: 'ğŸ´', money: 200, canDrive: true, size: 1 }
        ];

        const MALE_IDS = ['hanguoyu', 'fuqunzhu', 'luozhiqiang', 'yeyuanzhi', 'mayingjeou', 'zhulilun'];
        const WANG_PROTECTORS = ['luozhiqiang', 'fuqunzhu', 'hanguoyu', 'zhulilun'];

        // ç‹€æ…‹è®Šæ•¸
        let chars = []; // åŸ·è¡ŒæœŸè§’è‰²è³‡æ–™
        let boatLoc = 'taiwan'; // 'taiwan' | 'china'
        let chinaArrivals = []; // æŠµé”é †åº
        let isGameOver = false;

        // DOM å…ƒç´ 
        const elStage = document.getElementById('stage');
        const elBoat = document.getElementById('boat');
        const elChina = document.getElementById('chars-china');
        const elTaiwan = document.getElementById('chars-taiwan');
        const elDeadList = document.getElementById('list-dead');
        const elLogList = document.getElementById('list-log');
        const btnMove = document.getElementById('btn-move');

        // --- åˆå§‹åŒ– ---
        function initGame() {
            // æ·±æ‹·è²åˆå§‹è³‡æ–™
            chars = JSON.parse(JSON.stringify(INITIAL_CHARS));
            chars.forEach(c => {
                c.location = 'taiwan'; // åˆå§‹å…¨åœ¨å°ç£
                c.isAlive = true;
            });

            boatLoc = 'taiwan';
            chinaArrivals = [];
            isGameOver = false;

            // æ¸…ç©º UI
            elDeadList.innerHTML = '';
            elLogList.innerHTML = '';
            btnMove.disabled = false;
            btnMove.style.background = '#e53935';
            btnMove.textContent = 'ğŸš¢ é–‹èˆ¹ (GO)';

            log('éŠæˆ²é–‹å§‹ï¼ç›®æ¨™ï¼šå°‡ç«‹å§”é‹å¾€ä¸­åœ‹ã€‚');
            render();
        }

        // --- æ¸²æŸ“ç•«é¢ (Render) ---
        function render() {
            // æ¸…ç©ºèˆŠå…ƒç´ 
            [elChina, elTaiwan].forEach(el => el.innerHTML = '');
            // ä¿ç•™èˆ¹çš„çµæ§‹ï¼Œåªæ¸…ç©ºè§’è‰² (é™¤äº† flag)
            const children = Array.from(elBoat.children);
            children.forEach(child => {
                if(!child.classList.contains('flag')) elBoat.removeChild(child);
            });

            // 1. è¨­å®šèˆ¹ä½ç½® (CSS Transition)
            if (boatLoc === 'taiwan') {
                elBoat.style.left = 'calc(100% - 200px)'; // é å³
            } else {
                elBoat.style.left = '40px'; // é å·¦
            }

            // 2. ç¹ªè£½è§’è‰²
            chars.forEach(c => {
                if (!c.isAlive) return;

                const div = document.createElement('div');
                div.className = 'char';
                div.dataset.id = c.id;
                div.onclick = (e) => { e.stopPropagation(); clickChar(c.id); };
                
                div.innerHTML = `
                    <div class="char-img">${c.emoji}</div>
                    <div class="char-info">${c.name}</div>
                    <div class="char-info" style="color:green">$${c.money}</div>
                    <div class="bubble" id="bubble-${c.id}"></div>
                `;

                // æ”¾ç½®ä½ç½®
                if (c.location === 'taiwan') elTaiwan.appendChild(div);
                else if (c.location === 'china') elChina.appendChild(div);
                else if (c.location === 'boat') elBoat.appendChild(div);
            });
        }

        // --- äº’å‹•é‚è¼¯ ---
        function clickChar(id) {
            if (isGameOver) return;

            const c = chars.find(x => x.id === id);
            
            // ä¸Šä¸‹èˆ¹é‚è¼¯
            if (c.location === 'boat') {
                // ä¸‹èˆ¹ -> å›åˆ°ç•¶å‰å²¸é‚Š
                c.location = boatLoc;
                log(`${c.name} ä¸‹èˆ¹ã€‚`);
            } else {
                // ä¸Šèˆ¹
                if (c.location !== boatLoc) {
                    bubble(c.id, "èˆ¹åœ¨å°é¢å•Šï¼");
                    return;
                }
                
                const boatSize = getBoatSize();
                if (boatSize + c.size > 2) {
                    bubble(c.id, "æ“ ä¸ä¸‹å•¦ï¼");
                    log("èˆ¹æ»¿äº†ã€‚");
                    return;
                }
                
                c.location = 'boat';
                log(`${c.name} ä¸Šèˆ¹ã€‚`);
            }
            render();
        }

        function moveBoat() {
            if (isGameOver) return;

            const onBoat = chars.filter(c => c.location === 'boat');
            
            // 1. ç©ºèˆ¹æª¢æŸ¥
            if (onBoat.length === 0) {
                log("ç©ºèˆ¹ç„¡æ³•ç§»å‹•ã€‚");
                return;
            }

            // 2. é§•é§›æª¢æŸ¥
            const hasDriver = onBoat.some(c => c.canDrive);
            const fu = onBoat.find(c => c.id === 'fuqunzhu');
            const ye = onBoat.find(c => c.id === 'yeyuanzhi');

            // å‚…å´‘èæ¶èˆ¹ (æœ‰å‚…ï¼Œç„¡å…¶ä»–å¸æ©Ÿ)
            if (fu && !hasDriver) {
                bubble(fu.id, "éƒ½æ˜¯ä¸­å¤®çš„éŒ¯ï¼");
                log("å‚…å´‘èæ¶è‘—é–‹èˆ¹...");
                handleSinking('fu_drive');
                return;
            }

            // ç„¡äººæœƒé–‹ (ç„¡å‚…ï¼Œç„¡å¸æ©Ÿ)
            if (!fu && !hasDriver) {
                if (ye) bubble(ye.id, "æŠ–æŠ–æŠ–...");
                log("æ²’äººæœƒé–‹èˆ¹ï¼Œèˆ¹åœ¨åŸåœ°æ‰“è½‰ã€‚");
                return;
            }

            // 3. èˆ¹ä¸Šæ®ºäººäº‹ä»¶
            if (checkBoatKill(onBoat)) return; // å¦‚æœæœ‰äººæ­»æ‰ï¼Œé€™æ¬¡ç§»å‹•å–æ¶ˆ

            // 4. ç¾…æ™ºå¼·æ”¶è²»
            const luo = onBoat.find(c => c.id === 'luozhiqiang');
            if (luo && getBoatSize() === 2) { // æ»¿å“¡æ‰æ”¶è²» (å‡è¨­)
                const victim = onBoat.find(c => c.id !== 'luozhiqiang');
                if (victim.money < 100) {
                    bubble(luo.id, "æ²’éŒ¢æ»¾ä¸‹å»ï¼");
                    kill(luo.id, `è¢« ${victim.name} æ²’éŒ¢è²·æ›¸åæ®ºæ¨ä¸‹æµ·`); // é€™è£¡åŸæœ¬é‚è¼¯æ˜¯ç¾…è¢«ä¸Ÿä¸‹èˆ¹
                    // ä¿®æ­£ï¼šåŸè¦å‰‡æ˜¯ã€Œç¾…è¢«ä¸Ÿä¸‹èˆ¹ã€ã€‚
                    return;
                } else {
                    victim.money -= 100;
                    luo.money += 100;
                    bubble(luo.id, "è¬è¬æƒ é¡§ï¼");
                    log(`${luo.name} è³£äº†ä¸€æœ¬æ›¸çµ¦ ${victim.name} (è³º100è¬)ã€‚`);
                }
            }

            // 5. åŸ·è¡Œç§»å‹•
            const from = boatLoc;
            const to = boatLoc === 'taiwan' ? 'china' : 'taiwan';
            boatLoc = to;
            log(`èˆ¹å¾ ${from === 'taiwan' ? 'å°ç£' : 'ä¸­åœ‹'} é–‹å¾€ ${to === 'china' ? 'ä¸­åœ‹' : 'å°ç£'}...`);
            render(); // è§¸ç™¼å‹•ç•«

            // å»¶é²è™•ç†æŠµé”é‚è¼¯ (é…åˆ CSS 1.5s å‹•ç•«)
            setTimeout(() => {
                handleArrival(to);
            }, 1500);
        }

        function handleArrival(loc) {
            if (isGameOver) return;
            
            // è§’è‰²å¼·åˆ¶ä¸‹èˆ¹åˆ°æ–°åœ°é» (æˆ–ä¿ç•™åœ¨èˆ¹ä¸Šï¼Œçœ‹åŸè¦å‰‡ã€‚é€šå¸¸æ˜¯ç•™åœ¨èˆ¹ä¸Šéœ€æ‰‹å‹•ä¸‹ï¼Œä½†é€™è£¡ç°¡åŒ–é‚è¼¯ï¼Œç‹€æ…‹ä»åœ¨èˆ¹ä¸Šï¼Œåªæ˜¯èˆ¹çš„ä½ç½®è®Šäº†)
            // é€™è£¡æˆ‘å€‘åªéœ€æ›´æ–°é‚è¼¯ç‹€æ…‹ï¼Œä¸å¼·åˆ¶ä¸‹èˆ¹ï¼Œä½†éœ€æª¢æŸ¥ã€ŒæŠµé”ä¸­åœ‹ã€çš„è¨ˆæ•¸

            const onBoat = chars.filter(c => c.location === 'boat');
            
            if (loc === 'china') {
                onBoat.forEach(c => {
                    if (!chinaArrivals.includes(c.id)) {
                        chinaArrivals.push(c.id);
                        log(`${c.name} æŠµé”ä¸­åœ‹ (ç¬¬ ${chinaArrivals.length} ä½)ã€‚`);
                        
                        // é„­éº—æ–‡è¨ˆæ™‚å™¨
                        if (c.id === 'zhengliwen' && chinaArrivals.length > 5) {
                            bubble(c.id, "æˆ‘é²åˆ°äº†ï¼æ°£æ­»ï¼");
                            handleSinking('zheng_late');
                        }
                    }
                });
            }

            // å²¸ä¸Šå¤§å± æ®ºæª¢æŸ¥ (æ¯æ¬¡é å²¸éƒ½æª¢æŸ¥)
            checkShoreRules();
            checkWinCondition();
        }

        // --- è¦å‰‡åˆ¤å®šå‡½æ•¸ ---

        function checkBoatKill(onBoat) {
            // å¿…é ˆå›å‚³ true å¦‚æœæœ‰äººæ­»äº†
            const ids = onBoat.map(c => c.id);
            const has = (id) => ids.includes(id);
            
            // éŸ“æ®ºå‚… (ç„¡æœ±)
            if (has('hanguoyu') && has('fuqunzhu') && !has('zhulilun')) {
                bubble('hanguoyu', "ä¸‹å»å§ä½ ï¼");
                kill('fuqunzhu', "èˆ¹ä¸Šè¢«éŸ“åœ‹ç‘œæ¨ä¸‹æµ·");
                return true;
            }
            // é¦¬æ®ºå‚… (ç„¡æœ±)
            if (has('mayingjeou') && has('fuqunzhu') && !has('zhulilun')) {
                bubble('mayingjeou', "æ­»äº¡ä¹‹æ¡ï¼");
                kill('fuqunzhu', "èˆ¹ä¸Šè¢«é¦¬è‹±ä¹æ¨ä¸‹æµ·");
                return true;
            }
            // ç‹é´»è–‡æ®ºå¾
            if (has('wanghongwei') && has('xuxiaoqin')) {
                bubble('wanghongwei', "æ»¾ï¼");
                kill('xuxiaoqin', "èˆ¹ä¸Šè¢«ç‹é´»è–‡ä¸Ÿä¸‹æµ·");
                return true;
            }
            // ç‹é´»è–‡æ®ºç”·
            const wang = onBoat.find(c => c.id === 'wanghongwei');
            const man = onBoat.find(c => MALE_IDS.includes(c.id));
            if (wang && man) {
                bubble(wang.id, "è®Šæ…‹èµ°é–‹ï¼");
                kill(man.id, "èˆ¹ä¸Šè¢«ç‹é´»è–‡æ¨ä¸‹æµ·");
                return true;
            }
            // å¾ç½µäºº (ç„¡é„­) -> èˆ¹ä¸é–‹
            if (has('xuxiaoqin') && !has('zhengliwen')) {
                bubble('xuxiaoqin', "èœœç¾ç”Ÿæ°£æ°£ï¼");
                log("å¾å·§èŠ¯ç‹‚ç½µï¼Œæ²’äººæ•¢é–‹èˆ¹ã€‚");
                return true; // é›–ç„¶æ²’æ­»ï¼Œä½†é˜»æ“‹é–‹èˆ¹ï¼Œè¦–ç‚ºä¸€ç¨®ä¸­æ–·
            }

            return false;
        }

        function checkShoreRules() {
            if(isGameOver) return;

            // 1. å°ç£å²¸ä¸Š (ç‹é´»è–‡, å‚…å´‘è)
            const twChars = chars.filter(c => c.location === 'taiwan' && c.isAlive);
            const hasTw = (id) => twChars.some(c => c.id === id);

            // ç‹é´»è–‡äº‚æ®º
            if (hasTw('wanghongwei')) {
                const protectors = twChars.some(c => WANG_PROTECTORS.includes(c.id));
                if (!protectors) {
                    // æ®ºä¸€å€‹ç”·çš„
                    const victims = twChars.filter(c => MALE_IDS.includes(c.id) && c.id !== 'fuqunzhu');
                    if (victims.length > 0) {
                        const v = victims[Math.floor(Math.random() * victims.length)];
                        bubble('wanghongwei', "æ²’å¤§äººæˆ‘å°±äº‚æ®ºï¼");
                        kill(v.id, "å°ç£å²¸ä¸Šè¢«ç‹é´»è–‡éš¨æ©Ÿæ®ºå®³");
                        return; // ä¸€æ¬¡æ®ºä¸€å€‹å°±å¥½ï¼Œé¿å…è¿´åœˆå•é¡Œ
                    }
                }
            }

            // å‚…å´‘èè¢«æ®º (ç„¡æœ±)
            if (hasTw('fuqunzhu') && !hasTw('zhulilun')) {
                if (hasTw('hanguoyu')) {
                    bubble('hanguoyu', "å²¸ä¸Šä¹Ÿæ®ºï¼");
                    kill('fuqunzhu', "å°ç£å²¸ä¸Šè¢«éŸ“åœ‹ç‘œæ®ºå®³");
                } else if (hasTw('mayingjeou')) {
                    bubble('mayingjeou', "æ­»äº¡ä¹‹æ¡ï¼");
                    kill('fuqunzhu', "å°ç£å²¸ä¸Šè¢«é¦¬è‹±ä¹æ®ºå®³");
                }
            }

            // 2. ä¸­åœ‹å²¸ä¸Š (ç¿æ›‰ç²)
            const cnChars = chars.filter(c => c.location === 'china' && c.isAlive);
            const hasCn = (id) => cnChars.some(c => c.id === id);
            
            if (hasCn('wengxiaoling')) {
                if (!hasCn('fuqunzhu') && !hasCn('zhengliwen')) {
                    bubble('wengxiaoling', "èª°ä¾†æ•‘æˆ‘ï¼");
                    kill('wengxiaoling', "ä¸­åœ‹å²¸ä¸Šç„¡äººä¿è­·è¢«ä¸Ÿä¸‹æµ·");
                }
            }
        }

        function handleSinking(reason) {
            isGameOver = true;
            let msg = "";
            if (reason === 'fu_drive') msg = "å‚…å´‘èé–‹èˆ¹æ²ˆæ²’ (å…¨å“¡æ­»äº¡)";
            if (reason === 'zheng_late') msg = "é„­éº—æ–‡é²åˆ°æš´æ€’æ²ˆèˆ¹";

            log(msg);
            
            // èˆ¹ä¸Šå…¨æ­»
            chars.filter(c => c.location === 'boat').forEach(c => c.isAlive = false);
            
            // æª¢æŸ¥è§£æ”¾è»æ¢æ¬¾ (ä¸­åœ‹ < 5äºº)
            const cnCount = chars.filter(c => c.location === 'china' && c.isAlive).length;
            if (cnCount < 5) {
                log("ä¸­åœ‹å²¸ä¸Šäººæ•¸ä¸è¶³ï¼Œè§£æ”¾è»è‚…æ¸…ï¼");
                chars.filter(c => c.location === 'china').forEach(c => c.isAlive = false);
            }

            // æª¢æŸ¥å…¨æ»…
            const cnAlive = chars.filter(c => c.location === 'china' && c.isAlive).length;
            if (cnAlive === 0) {
                log("ä¸­åœ‹ç„¡äººç”Ÿé‚„ï¼Œå°ç£ç«¯å…¨é«”è™•æ±ºï¼");
                chars.forEach(c => c.isAlive = false);
            }
            
            render();
            checkWinCondition();
        }

        function kill(id, reason) {
            const c = chars.find(x => x.id === id);
            if (c && c.isAlive) {
                c.isAlive = false;
                c.location = 'dead'; // ç§»å‡ºåœ°åœ–
                const li = document.createElement('li');
                li.innerText = `${c.name}: ${reason}`;
                elDeadList.appendChild(li);
                log(`${c.name} æ­»äº¡ã€‚`);
                render();
            }
        }

        function checkWinCondition() {
            if (isGameOver) return; // å·²åœ¨æ²ˆèˆ¹é‚è¼¯è™•ç†é

            const alive = chars.filter(c => c.isAlive);
            
            if (alive.length === 0) {
                endGame(false, "å…¨é«”æ­»äº¡ï¼å°ç£äººæ°‘å‹åˆ©ï¼");
                return;
            }

            const allInChina = alive.every(c => c.location === 'china');
            if (allInChina) {
                if (alive.length >= 5) {
                    endGame(true, `æˆåŠŸæ’¤é›¢ ${alive.length} äººï¼åœ‹æ°‘é»¨å‹åˆ©ï¼`);
                } else {
                    endGame(false, `æ’¤é›¢äººæ•¸ (${alive.length}) ä¸è¶³ 5 äººã€‚ä»»å‹™å¤±æ•—ã€‚`);
                }
            }
        }

        function endGame(win, msg) {
            isGameOver = true;
            log("=== éŠæˆ²çµæŸ ===");
            log(msg);
            alert(msg);
            btnMove.disabled = true;
            btnMove.textContent = 'è«‹æŒ‰é‡ç½®';
            btnMove.style.background = '#999';
        }

        // --- å·¥å…·å‡½æ•¸ ---
        function getBoatSize() {
            return chars.filter(c => c.location === 'boat').reduce((acc, c) => acc + c.size, 0);
        }

        function log(msg) {
            const time = new Date().toLocaleTimeString('en-US', {hour12: false});
            const li = document.createElement('li');
            li.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
            elLogList.prepend(li);
        }

        function bubble(id, text) {
            const el = document.getElementById(`bubble-${id}`);
            if (el) {
                el.innerText = text;
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 2000);
            }
        }

        // å•Ÿå‹•
        initGame();

    </script>
</body>
</html>
